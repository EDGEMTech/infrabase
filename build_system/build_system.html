

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. Build System &mdash; Infrabase 0.5.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/style.css" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=8245a45c" />

  
      <script src="../_static/documentation_options.js?v=1dd76d02"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Development flow" href="../dev_flow.html" />
    <link rel="prev" title="3. User Guide" href="../user_guide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Infrabase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rootfs/rootfs.html">2. User applications and rootfs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">3. User guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Build System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bitbake-environment">4.1. Bitbake environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#infrabase-build-system">4.2. Infrabase build system</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-system-directory-organization">4.3. Build system directory organization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#directory-conf">4.3.1. Directory <code class="docutils literal notranslate"><span class="pre">conf/</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#directory-meta-linux-classes">4.3.2. Directory <code class="docutils literal notranslate"><span class="pre">meta-linux/classes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#directory-meta-linux-conf">4.3.3. Directory <code class="docutils literal notranslate"><span class="pre">meta-linux/conf</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#directory-recipes">4.3.4. Directory <code class="docutils literal notranslate"><span class="pre">recipes-*</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-recipe">4.3.4.1. The recipe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#patchset">4.3.4.2. Patchset</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#directory-tmp">4.3.5. Directory <code class="docutils literal notranslate"><span class="pre">tmp</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#infrabase-basic-workflow">4.4. Infrabase Basic workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-a-patchset">4.4.1. Building a patchset</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#infrabase-recipes">4.5. Infrabase recipes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-comments">4.5.1. General comments</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dev_flow.html">5. Development  flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../base_extension/base_extension.html">6. Base environnement extension for Infrabase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coding_conventions.html">7. Coding conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">8. Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Infrabase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">4. </span>Build System</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="build-system">
<span id="id1"></span><h1><span class="section-number">4. </span>Build System<a class="headerlink" href="#build-system" title="Link to this heading">¶</a></h1>
<p>This chapter gives an overview of the Infrabase build system.
The build commands are given in the <a class="reference internal" href="../user_guide.html#user-guide"><span class="std std-ref">user guide chapter</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Infrabase</span></code> build system relies on various scripts and methods, but is mainly
driven by <code class="docutils literal notranslate"><span class="pre">bitbake</span></code> receipes.</p>
<p>We call <code class="docutils literal notranslate"><span class="pre">standard</span> <span class="pre">scripts</span></code> those used so far as <code class="docutils literal notranslate"><span class="pre">./build.sh</span></code>, <code class="docutils literal notranslate"><span class="pre">./deploy.sh</span></code>, <code class="docutils literal notranslate"><span class="pre">./mount.sh</span></code>, etc.</p>
<p>The main concepts of <em>bitbake</em> are: <code class="docutils literal notranslate"><span class="pre">layers</span></code>, <code class="docutils literal notranslate"><span class="pre">configurations</span></code>, <code class="docutils literal notranslate"><span class="pre">classes</span></code>, <code class="docutils literal notranslate"><span class="pre">recipes</span></code> and <code class="docutils literal notranslate"><span class="pre">tasks</span></code>.</p>
<p>A layer can be defined as a collection of <em>configurations</em>, <em>classes</em> and <em>recipes</em> associated to
a component. It describes the overall build process with the different tasks belonging to recipes.</p>
<p>Classes are configuration-independent functionalities/tasks and can have hierarchies (a base class
can be inherited by other classes).</p>
<p>Receipes contain rules to be executed for a specific application or component.</p>
<p>Tasks are defined in classes or receipes and are the core functions managed by the build system.
Tasks are either (<strong>bash</strong>) shell script or <strong>python</strong> functions</p>
<p>Configurations are everyhwere, but the <code class="docutils literal notranslate"><span class="pre">local.conf</span></code> file located in <code class="docutils literal notranslate"><span class="pre">build/conf/</span></code> directory contains the
general configuration. Typically, this file contains the definition of <code class="docutils literal notranslate"><span class="pre">PLATFORM</span></code>
Configurations contain definition of <em>bitbake</em> variables that can be used by all recipes of the build system.</p>
<section id="bitbake-environment">
<h2><span class="section-number">4.1. </span>Bitbake environment<a class="headerlink" href="#bitbake-environment" title="Link to this heading">¶</a></h2>
<p>Infrabase build system relies on <a class="reference external" href="https://docs.yoctoproject.org/bitbake">Bitbake</a> which is the
underlying build system used by Yocto. The overall architecture is depicted on the figure below.</p>
<figure class="align-center" id="id2">
<img alt="../_images/Infrabase-Build_System.drawio.png" src="../_images/Infrabase-Build_System.drawio.png" />
<figcaption>
<p><span class="caption-number">Fig. 4.1 </span><span class="caption-text">Differences between Yocto and Infrabase in the build system architecture</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>While Yocto is mainly distribution oriented (and Poky is the distribution reference on top of Yocto), Infrabase
enables the building of various distributions, for example based on <strong>buildroot</strong> or <strong>debootstrap</strong>.</p>
<p><strong>Open-embedded</strong> is constituted of various meta files which enhance the <em>bitbake</em> build system and it
has to be considered as part of the build system.</p>
</section>
<section id="infrabase-build-system">
<h2><span class="section-number">4.2. </span>Infrabase build system<a class="headerlink" href="#infrabase-build-system" title="Link to this heading">¶</a></h2>
<p>In <em>Infrabase</em>, <em>bitbake</em> and some small parts of <em>openembedded</em> are used to build
the initial environment and to reconciliate patches of components after some modifications of source code.</p>
<p>After the initial clone of the repository, <em>bitbake</em> allows to build all components by fetching the
code from the original location and applying related patchsets.</p>
<p>The updates of patches following some modifications of the repository are part of <a class="reference internal" href="../dev_flow.html#dev-flow"><span class="std std-ref">the development flow</span></a>.</p>
<p>We differ <em>bitbake</em> script from <a class="reference internal" href="../glossary.html#term-Standard-script"><span class="xref std std-term">standard script</span></a>. During the development, the standard scripts
available at the root directory and subdirectory (like <em>rootfs/</em> or <em>linux/usr</em>) should be used.</p>
</section>
<section id="build-system-directory-organization">
<h2><span class="section-number">4.3. </span>Build system directory organization<a class="headerlink" href="#build-system-directory-organization" title="Link to this heading">¶</a></h2>
<p>All build system files (except the standard scripts) are located in the <code class="docutils literal notranslate"><span class="pre">build/</span></code> directory.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not erase the <code class="docutils literal notranslate"><span class="pre">build/</span></code> directory. It is not automatically generated but
is stored <em>git</em>.</p>
</div>
<p>Actually, <em>bitbake</em> creates a <code class="docutils literal notranslate"><span class="pre">tmp/</span></code> subdirectory within <code class="docutils literal notranslate"><span class="pre">build/</span></code>. If a complete re-build is required,
you can delete <em>tmp/</em> at any time.</p>
<figure class="align-center" id="id3">
<img alt="../_images/Infrabase-IB_Architecture.drawio.png" src="../_images/Infrabase-IB_Architecture.drawio.png" />
<figcaption>
<p><span class="caption-number">Fig. 4.2 </span><span class="caption-text">Build system directory organization as stored in git</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>In <em>bitbake</em>, a layer corresponds to a <code class="docutils literal notranslate"><span class="pre">meta</span></code> directory entry. For example, the <em>meta/</em> directory is
a generic layer which is used by all other layers.</p>
<p>We focus on the <strong>meta-linux</strong> layer as an example.</p>
<section id="directory-conf">
<h3><span class="section-number">4.3.1. </span>Directory <code class="docutils literal notranslate"><span class="pre">conf/</span></code><a class="headerlink" href="#directory-conf" title="Link to this heading">¶</a></h3>
<p>This directory is general to the build system and defines the main configuration for <em>bitbake</em> (in <em>bitbake.conf</em>)
and for the project (in <em>local.conf</em>).</p>
<p>Each new layer must be added in <em>bitbake.conf</em> in order to tell <em>bitbake</em> to consider the recipes describes in this layer.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">local.conf</span></code>, most variables are specific to <em>infrabase</em>, like:</p>
<blockquote>
<div><ul class="simple">
<li><p>IB_PLATFORM</p></li>
<li><p>IB_STORAGE</p></li>
<li><p>IB_TOOLCHAIN</p></li>
<li><p><em>etc.</em></p></li>
</ul>
</div></blockquote>
</section>
<section id="directory-meta-linux-classes">
<h3><span class="section-number">4.3.2. </span>Directory <code class="docutils literal notranslate"><span class="pre">meta-linux/classes</span></code><a class="headerlink" href="#directory-meta-linux-classes" title="Link to this heading">¶</a></h3>
<p>It defines the generic tasks/functions that are used by the recipe, like <code class="docutils literal notranslate"><span class="pre">do_configure</span></code> and <code class="docutils literal notranslate"><span class="pre">do_build</span></code> (two
examples of tasks)</p>
</section>
<section id="directory-meta-linux-conf">
<h3><span class="section-number">4.3.3. </span>Directory <code class="docutils literal notranslate"><span class="pre">meta-linux/conf</span></code><a class="headerlink" href="#directory-meta-linux-conf" title="Link to this heading">¶</a></h3>
<p>Each layer has a very similar file called <code class="docutils literal notranslate"><span class="pre">layer.conf</span></code> which tell <em>bitbake</em> further information
about the dependencies between layers and their priorities in the build process. Currently,
all layers are processed with the same priority (4).</p>
</section>
<section id="directory-recipes">
<h3><span class="section-number">4.3.4. </span>Directory <code class="docutils literal notranslate"><span class="pre">recipes-*</span></code><a class="headerlink" href="#directory-recipes" title="Link to this heading">¶</a></h3>
<p>These are the recipes of the layer. In most cases, there is one recipe by layer (except for <em>rootfs</em>) which
describes how to build the target component associated to the layer. Of course, depending on the number
of releases/versions, there can be several recipes as well.</p>
<p>Each recipe may have several subdirectories. Typically, a directory with the name of the component (<em>linux</em>)
which contains the recipe files and a <code class="docutils literal notranslate"><span class="pre">files/</span></code> directory which contains additional files like patches.</p>
<section id="the-recipe">
<h4><span class="section-number">4.3.4.1. </span>The recipe<a class="headerlink" href="#the-recipe" title="Link to this heading">¶</a></h4>
<p>The configuration and requirements of a recipe is given in a file with the <code class="docutils literal notranslate"><span class="pre">.bb</span></code> extension (for
example <code class="docutils literal notranslate"><span class="pre">linux-5.10.bb</span></code> in our case).</p>
</section>
<section id="patchset">
<h4><span class="section-number">4.3.4.2. </span>Patchset<a class="headerlink" href="#patchset" title="Link to this heading">¶</a></h4>
<p>A <em>patchset</em> is a collection pf patches which are processed during the build, with the <code class="docutils literal notranslate"><span class="pre">do_patch</span></code> tasks.
In <em>Infrabase</em>, the list of patches to be applied is contained in a file with <code class="docutils literal notranslate"><span class="pre">.inc</span></code> extension within
the <em>files/</em> directory. And the list of <em>.inc</em> files to be considered in the recipe is described in the
recipe file (<em>linux-5.10.bb</em>).</p>
</section>
</section>
<section id="directory-tmp">
<h3><span class="section-number">4.3.5. </span>Directory <code class="docutils literal notranslate"><span class="pre">tmp</span></code><a class="headerlink" href="#directory-tmp" title="Link to this heading">¶</a></h3>
<p><em>Bitbake</em> automatically creates a <code class="docutils literal notranslate"><span class="pre">tmp/</span></code> directory in <em>build/</em> for his management and project-related
files. The figure above shows the contents of this directory.</p>
<figure class="align-center" id="id4">
<img alt="../_images/Infrabase-Folders_tmp.drawio.png" src="../_images/Infrabase-Folders_tmp.drawio.png" />
<figcaption>
<p><span class="caption-number">Fig. 4.3 </span><span class="caption-text">Directory tree of the <em>tmp/</em> directory in <em>build/</em></span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Once a task is executed successfully, a stamp file (0 byte) is created so that <em>bitbake</em> will not re-execute</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that standard scripts remove the stamp files associated to the component to be re-built.
Only the <em>bsp</em> recipe does not delete the stamps for individual components except the one
corresponding to itself.</p>
</div>
</section>
</section>
<section id="infrabase-basic-workflow">
<h2><span class="section-number">4.4. </span>Infrabase Basic workflow<a class="headerlink" href="#infrabase-basic-workflow" title="Link to this heading">¶</a></h2>
<p>The initial build can be achieved by meas of the <code class="docutils literal notranslate"><span class="pre">./build.sh</span> <span class="pre">-a</span></code> command. It will fetch, patch, prepare
the environment and build everything (kernel, rootfs, apps, etc.).</p>
<p>In the build process, there is a particular task called <code class="docutils literal notranslate"><span class="pre">do_attach_infrabase</span></code> which perform a copy
of source code in the root environment of <em>infrabase</em>. Hence, the development can be done independently
of the <code class="docutils literal notranslate"><span class="pre">tmp/</span></code> directory managed by <em>bitbake</em>.</p>
<p>Therefore, the development is done on the source code related to the branch while the original files
are not modified (in <em>tmp/work/</em>) directories.</p>
<p>This will allow the developers to perform a <em>diff</em> (using the <code class="docutils literal notranslate"><span class="pre">do_updiff</span></code> task) which will generate
the patches for the differences.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It has to be noted that the generated patches are issued from the difference between the local
files and the original <strong>patched</strong> files. This leads to an incremental patching process.
The <em>diff</em> process is always done against the directory which is stored in <code class="docutils literal notranslate"><span class="pre">tmp/work/&lt;component&gt;/</span></code></p>
</div>
<section id="building-a-patchset">
<h3><span class="section-number">4.4.1. </span>Building a patchset<a class="headerlink" href="#building-a-patchset" title="Link to this heading">¶</a></h3>
<p>Following a development sprint, patchsets have to be (re-)generated in order to keep track of the
code evolution. This is achieved by means of the <code class="docutils literal notranslate"><span class="pre">do_updiff</span></code> task. It has to be executed in the
<code class="docutils literal notranslate"><span class="pre">build</span></code> directory. For example, if we do changes in linux, the patchset will be generated
with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/infrabase/build$<span class="w"> </span>bitbake<span class="w"> </span>linux<span class="w"> </span>-c<span class="w"> </span>updiff
</pre></div>
</div>
<p>As result, the patchset is generated in <code class="docutils literal notranslate"><span class="pre">build/meta-linux/recipes-linux/linux/files</span></code> directory with
the file <code class="docutils literal notranslate"><span class="pre">000x-linux-5.10-r0-patches.inc</span></code> and its associated directory called <code class="docutils literal notranslate"><span class="pre">000x-linux-5.10-r0</span></code>
in which the set of patches is located.</p>
<p>The prefix is made of four digits and is incremented at each patchset generation.</p>
<p>Based on these two elements, the patchset can be manually worked out.</p>
<p>To include a patchset in a recipe, the recipe file has to include the following lines:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>FILESPATH:prepend:<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">THISDIR</span><span class="si">}</span><span class="s2">/files/0001-</span><span class="si">${</span><span class="nv">PF</span><span class="si">}</span><span class="s2">:&quot;</span>

require<span class="w"> </span>files/0001-<span class="si">${</span><span class="nv">PF</span><span class="si">}</span>-patches.inc
</pre></div>
</div>
<p>Each recipe can have one or several patchsets according to the patch organization, and
the first patchset should be called with prefix <code class="docutils literal notranslate"><span class="pre">0001-</span></code></p>
</section>
</section>
<section id="infrabase-recipes">
<h2><span class="section-number">4.5. </span>Infrabase recipes<a class="headerlink" href="#infrabase-recipes" title="Link to this heading">¶</a></h2>
<section id="general-comments">
<h3><span class="section-number">4.5.1. </span>General comments<a class="headerlink" href="#general-comments" title="Link to this heading">¶</a></h3>
<p>If a task requires <code class="docutils literal notranslate"><span class="pre">sudo</span></code> to execute a command, it has to be configured so that no password is required.
To do this, the following entry in the file <code class="docutils literal notranslate"><span class="pre">/etc/sudoers</span></code> should be added:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;user&gt;<span class="w">  </span><span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span><span class="w"> </span>NOPASSWD:<span class="w"> </span>ALL
</pre></div>
</div>
<p>Currently, the use of <em>fakeroot</em> commands, that could avoid setting no password with sudo,
does not allow to use <code class="docutils literal notranslate"><span class="pre">losetup</span></code> correctly.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">sudo</span></code> in a task involves to set the attribute <code class="docutils literal notranslate"><span class="pre">network</span></code> of this task to <code class="docutils literal notranslate"><span class="pre">&quot;1&quot;</span></code>. For example:
<em>do_init_storage[network] = “1”</em></p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../user_guide.html" class="btn btn-neutral float-left" title="3. User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../dev_flow.html" class="btn btn-neutral float-right" title="5. Development flow" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2025, EDGEMTech Ltd (Switzerland).
      <span class="lastupdated">Last updated on 10 Oct 2025, 07:47.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>