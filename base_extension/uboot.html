

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6.5. U-Boot modifications &mdash; Infrabase 0.5.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/style.css" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=8245a45c" />

  
      <script src="../_static/documentation_options.js?v=1dd76d02"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7. Infrabase coding conventions" href="../coding_conventions.html" />
    <link rel="prev" title="6.4. Buildroot" href="buildroot.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Infrabase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rootfs/rootfs.html">2. User applications and rootfs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">3. User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_system/build_system.html">4. Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_flow.html">5. Development  flow</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="base_extension.html">6. Base environnement extension for Infrabase</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="armbian.html">6.1. Armbian full system</a></li>
<li class="toctree-l2"><a class="reference internal" href="debootstrap.html">6.2. Debootstrap rootfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="raspberrypiOS.html">6.3. Raspberry Pi OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="buildroot.html">6.4. Buildroot</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.5. U-Boot modifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="#further-improvements">6.6. Further improvements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../coding_conventions.html">7. Coding conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">8. Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Infrabase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="base_extension.html"><span class="section-number">6. </span>Base environnement extension for Infrabase</a></li>
      <li class="breadcrumb-item active"><span class="section-number">6.5. </span>U-Boot modifications</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="u-boot-modifications">
<span id="uboot"></span><h1><span class="section-number">6.5. </span>U-Boot modifications<a class="headerlink" href="#u-boot-modifications" title="Link to this heading">¶</a></h1>
<p>In order to support the boot from the ITB while using the DTB prepared by the RPi bootloader, we needed to modify U-Boot.
The original could only boot from one or the other method.</p>
<p>The RPi bootloader patches the DTB using the overlays specified in the config.txt file. When U-Boot takes the hand, the env variable <code class="docutils literal notranslate"><span class="pre">fdt_addr</span></code> is set to the address of the modified DTB.
The fix was to add a configuration <code class="docutils literal notranslate"><span class="pre">CONFIG_USE_RPI4_DTB_WITH_FIT</span></code> to be able to bypass the DTB retrieval in the FIT image (ITB).
We also need U-Boot to fill it with initrd information for Linux to be able to mount it.</p>
<p>All the modifications are done in <code class="docutils literal notranslate"><span class="pre">common/bootm.c</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p>line 283: If we use the new config, U-Boot sets its internal <code class="docutils literal notranslate"><span class="pre">fdt_addr</span></code> and <code class="docutils literal notranslate"><span class="pre">fdt_len</span></code> not by reading the ITB and parsinbg the DTB, but by reading the <code class="docutils literal notranslate"><span class="pre">fdtaddr</span></code> variable.</p></li>
<li><p>line 762: With the new configuration, it ignores the state check when configuring the DTB, it allow to configure it even without a DTB in the FIT image.</p></li>
</ul>
</div></blockquote>
</section>
<section id="further-improvements">
<h1><span class="section-number">6.6. </span>Further improvements<a class="headerlink" href="#further-improvements" title="Link to this heading">¶</a></h1>
<p>These modifications where implemented in a quick way to be able to use the custom DTB. However, it lacks some checks made by the classical path.
It is usable but still need some refining in how we handle the DTB loading.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="buildroot.html" class="btn btn-neutral float-left" title="6.4. Buildroot" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../coding_conventions.html" class="btn btn-neutral float-right" title="7. Infrabase coding conventions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2025, EDGEMTech Ltd (Switzerland).
      <span class="lastupdated">Last updated on 10 Oct 2025, 07:47.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>